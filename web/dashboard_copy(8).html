<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>惠斯安普数字人交互平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --background-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            padding-top: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: none;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-bottom: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            background-color: #000;
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            max-width: 100%;
            max-height: 100%;
            display: block;
            border-radius: var(--border-radius);
        }

        .controls-container {
            padding: 20px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .form-control {
            border-radius: var(--border-radius);
            padding: 10px 15px;
            border: 1px solid #ced4da;
        }

        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .status-connecting {
            background-color: #ffc107;
        }

        .asr-container {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
        }

        .asr-text {
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
        }

        .system-message {
            background-color: #f1f8e9;
            border-left: 4px solid #8bc34a;
        }

        .recording-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: none;
        }

        .recording-indicator.active {
            display: flex;
            align-items: center;
        }

        .recording-indicator .blink {
            width: 10px;
            height: 10px;
            background-color: #fff;
            border-radius: 50%;
            margin-right: 5px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }

        .mode-switch {
            margin-bottom: 20px;
        }

        .nav-tabs .nav-link {
            color: var(--text-color);
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--card-bg);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .settings-panel {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .voice-record-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }

        .voice-record-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        .voice-record-btn:active {
            background-color: #dc3545;
            transform: scale(0.95);
        }

        .voice-record-btn i {
            font-size: 24px;
        }

        .voice-record-label {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }

        .video-size-control {
            margin-top: 15px;
        }

        .recording-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(220, 53, 69, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }

        .option-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .check-btn {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
        }

        .check-btn.checked {
            background-color: #198754;
            color: white;
        }

        .radar-btn {
            background-color: #ffc107;
            position: relative;
        }

        .radar-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(255, 193, 7, 0.5);
            animation: radar 1.5s infinite;
            opacity: 0;
        }

        @keyframes radar {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 新增HRA按钮样式 */
        .hra-toggle-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #f8f9fa;
            color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--primary-color);
        }

        .hra-toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .hra-toggle-btn:hover {
            transform: scale(1.05);
        }

        /* 新增：设置面板下方按钮容器样式 */
        .settings-bottom-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 15px 20px 5px;
            background-color: #f8f9fa;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        /* 新增：选择框样式 */
        .radar-form-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 300px;
            width: 100%;
        }

        .radar-form-container label {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .radar-form-container select {
            width: 100%;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
            margin-bottom: 10px;
        }

        .radar-form-container button {
            margin: 0 auto;
        }

        /* 新增：统一的按钮和表单容器 */
        .control-buttons-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        /* 响应式布局调整 */
        @media (max-width: 768px) {
            .settings-bottom-buttons {
                gap: 20px;
            }

            .control-buttons-container {
                flex-direction: column;
                gap: 15px;
            }

            .radar-form-container {
                width: 100%;
            }
        }
        /* 响应式布局调整 */
        @media (min-width: 768px) {
            .control-unit {
                width: 30%; /* 中等屏幕以上每个单元占30%宽度 */
            }
        }

        @media (max-width: 768px) {
            .settings-bottom-buttons {
                gap: 20px;
            }

            .control-buttons-container {
                flex-direction: column;
                align-items: center;
            }

            .control-unit {
                max-width: 100%;
                width: 100%;
            }
        }
    </style>
</head>

<body>
<div class="dashboard-container">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">惠斯安普数字人交互平台</h1>
        </div>
    </div>

    <div class="row">
        <!-- 视频区域 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="status-indicator status-disconnected" id="connection-status"></span>
                        <span id="status-text">未连接</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="video-container">
                        <video id="video" autoplay playsinline></video>
                        <div class="recording-indicator" id="recording-indicator">
                            <div class="blink"></div>
                            <span>录制中</span>
                        </div>
                    </div>

                    <div class="controls-container">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <button class="btn btn-primary w-100" id="start">
                                    <i class="bi bi-play-fill"></i> 开始连接
                                </button>
                                <button class="btn btn-danger w-100" id="stop" style="display: none;">
                                    <i class="bi bi-stop-fill"></i> 停止连接
                                </button>
                            </div>

                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="video-size-control">
                                    <label for="video-size-slider" class="form-label">视频大小调节: <span
                                            id="video-size-value">100%</span></label>
                                    <input type="range" class="form-range" id="video-size-slider" min="50" max="150"
                                           value="100">
                                </div>
                            </div>
                        </div>

                        <div class="settings-panel mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="use-stun">
                                        <label class="form-check-label" for="use-stun">使用STUN服务器</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 新增：设置面板下方按钮容器 -->
                        <div class="settings-bottom-buttons">
                            <!-- 新增：统一的按钮和表单容器 -->
                            <div class="control-buttons-container">
                                <!-- 新增HRA解析按钮 -->
                                <div class="control-unit">
                                    <div class="hra-toggle-btn" id="hra-toggle-btn">
                                        <span class="font-bold">HRA</span>

                                    </div>
                                    <input type="text" class="form-control mt-3" id="hra-textbox" placeholder="HRA输入内容">

                                </div>
                                <!-- 雷达按钮和选择框 -->
                                <div class="control-unit">
                                    <form id="radar-form">
                                        <button class="option-btn radar-btn" type="submit">
                                            <i class="bi bi-radar"></i>雷达
                                        </button>
                                    </form>
                                    <input type="text" class="form-control mt-3" id="radar-textbox" placeholder="雷达输入内容">
                                </div>
                                <!-- 用户选择单元 -->
                                <div class="control-unit">
                                    <label for="ids" class="mb-2 d-block">选择用户：</label>
                                    <select id="ids" name="ids" multiple class="form-control mb-3" style="height: 60px">
                                        <option value="1">用户1</option>
                                        <option value="2">用户2</option>
                                        <option value="3">用户3</option>
                                        <option value="4">用户4</option>
                                    </select>
                                    <button class="btn btn-primary w-100" id="user-select-btn">
                                        <i class="bi bi-check"></i> 增加HRA报告
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧交互 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">

                    <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat"
                            type="button" role="tab" aria-controls="chat" aria-selected="true">对话模式</button>


                </div>
                <div class="card-body">
                    <div class="tab-content" id="interaction-tabs-content">
                        <!-- 对话模式 -->
                        <div class="tab-pane fade show active" id="chat" role="tabpanel"
                             aria-labelledby="chat-tab">
                            <div class="asr-container mb-3" id="chat-messages">
                                <div class="asr-text system-message">
                                    惠惠: 欢迎使用惠斯安普医疗助手大模型，请点击左侧"开始连接"按钮开始对话。
                                </div>
                            </div>

                            <form id="chat-form">
                                <div class="input-group mb-3">
                                        <textarea class="form-control" id="chat-message" rows="3"
                                                  placeholder="输入您想对数字人说的话..."></textarea>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="bi bi-send"></i> 发送
                                    </button>
                                </div>
                            </form>

                            <!-- 按钮容器 - 只保留按住说话按钮 -->
                            <div class="button-container">
                                <!-- 按住说话按钮 -->
                                <div class="voice-record-btn" id="voice-record-btn">
                                    <i class="bi bi-mic-fill"></i>
                                </div>
                            </div>
                        </div>

                        <!-- 朗读模式 -->
                        <div class="tab-pane fade" id="tts" role="tabpanel" aria-labelledby="tts-tab">
                            <form id="echo-form">
                                <div class="mb-3">
                                    <label for="message" class="form-label">输入要朗读的文本</label>
                                    <textarea class="form-control" id="message" rows="6"
                                              placeholder="输入您想让数字人朗读的文字..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-volume-up"></i> 朗读文本
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Made with ❤️ by Marstaos | Frontend & Performance Optimization</p>
    </div>
</div>

<!-- 隐藏的会话ID -->
<input type="hidden" id="sessionid" value="0">


<script src="client.js"></script>
<script src="srs.sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#video-size-slider').on('input', function () {
            const value = $(this).val();
            $('#video-size-value').text(value + '%');
            $('#video').css('width', value + '%');
        });
        const transcriptBox = document.getElementById('chat-message');
        let recognition;
        let timeoutTimer;

        // 新增功能
        let isChecked = false;

        function toggleCheck() {
            const checkBtn = document.getElementById('check-btn');
            const checkIcon = checkBtn.querySelector('i');
            isChecked = !isChecked;
            if (isChecked) {
                checkBtn.classList.add('checked');
                checkIcon.style.display = 'block';
                console.log('选中状态：True');
            } else {
                checkBtn.classList.remove('checked');
                checkIcon.style.display = 'none';
                console.log('选中状态：False');
            }
        }
        function updateConnectionStatus(status) {
            const statusIndicator = $('#connection-status');
            const statusText = $('#status-text');

            statusIndicator.removeClass('status-connected status-disconnected status-connecting');

            switch (status) {
                case 'connected':
                    statusIndicator.addClass('status-connected');
                    statusText.text('已连接');
                    break;
                case 'connecting':
                    statusIndicator.addClass('status-connecting');
                    statusText.text('连接中...');
                    break;
                case 'disconnected':
                default:
                    statusIndicator.addClass('status-disconnected');
                    statusText.text('未连接');
                    break;
            }
        }

        // 添加聊天消息
        function addChatMessage(message, type = 'user') {
            const messagesContainer = $('#chat-messages');
            const messageClass = type === 'user' ? 'user-message' : 'system-message';
            const sender = type === 'user' ? '您' : '惠惠';

            const messageElement = $(`
                    <div class="asr-text ${messageClass}">
                        ${sender}: ${message}
                    </div>
                `);

            messagesContainer.append(messageElement);
            messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
        }

        // 开始/停止按钮
        $('#start').click(function () {
            updateConnectionStatus('connecting');
            start();
            $(this).hide();
            $('#stop').show();

            // 添加定时器检查视频流是否已加载
            let connectionCheckTimer = setInterval(function () {
                const video = document.getElementById('video');
                // 检查视频是否有数据
                if (video.readyState >= 3 && video.videoWidth > 0) {
                    updateConnectionStatus('connected');
                    clearInterval(connectionCheckTimer);
                }
            }, 2000); // 每2秒检查一次

            // 60秒后如果还是连接中状态，就停止检查
            setTimeout(function () {
                if (connectionCheckTimer) {
                    clearInterval(connectionCheckTimer);
                }
            }, 60000);
        });

        $('#stop').click(function () {
            stop();
            $(this).hide();
            $('#start').show();
            updateConnectionStatus('disconnected');
        });

        // 录制功能
        $('#btn_start_record').click(function () {
            console.log('Starting recording...');
            fetch('/record', {
                body: JSON.stringify({
                    type: 'start_record',
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(function (response) {
                if (response.ok) {
                    console.log('Recording started.');
                    $('#btn_start_record').prop('disabled', true);
                    $('#btn_stop_record').prop('disabled', false);
                    $('#recording-indicator').addClass('active');
                } else {
                    console.error('Failed to start recording.');
                }
            }).catch(function (error) {
                console.error('Error:', error);
            });
        });

        $('#btn_stop_record').click(function () {
            console.log('Stopping recording...');
            fetch('/record', {
                body: JSON.stringify({
                    type: 'end_record',
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(function (response) {
                if (response.ok) {
                    console.log('Recording stopped.');
                    $('#btn_start_record').prop('disabled', false);
                    $('#btn_stop_record').prop('disabled', true);
                    $('#recording-indicator').removeClass('active');
                } else {
                    console.error('Failed to stop recording.');
                }
            }).catch(function (error) {
                console.error('Error:', error);
            });
        });

        $('#echo-form').on('submit', function (e) {
            e.preventDefault();
            var message = $('#message').val();
            if (!message.trim()) return;

            console.log('Sending echo message:', message);

            fetch('/human', {
                body: JSON.stringify({
                    text: message,
                    type: 'echo',
                    interrupt: true,
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            });

            $('#message').val('');
            addChatMessage(`已发送朗读请求: "${message}"`, 'system');
        });


        // report_interpret  bool类型变量
        let report_interpret = false;
        // 是否回答问题
        let qa_flag = false;
        // 是否进行总结
        let total_interpret = false;
        // 问题temp
        let question = '';
        // 按系统划分，异常解析队列
        let interpretation_queue = [];
        // 按系统划分，问题队列
        let question_queue = [];
        // 用于遍历解析队列，出队接收
        let interpretation1 = '';
        // 剩余未回答的问题数
        let qa_numb = 0;
        // user_id 假数据
        var id=1;
        // 聊天模式表单提交
        function chat_form(mes) {
            var message = mes;
            if (!message.trim()) return;

            console.log('Sending chat message:', message);
            addChatMessage(message, 'user');

            if (qa_flag == true) {
                // 问题已经产生，开始回答，qa信息入库
                qa_numb--;
                console.log(qa_numb);
                message = "\"question\":\"" + question + "\",\"answer\":\"" + message + "\"";
                fetch('/human', {
                    body: JSON.stringify({
                        text: message,
                        type: 'answer',
                        user_id: id,
                        interrupt: true,
                        qa_numb: qa_numb,
                        report_interpret: report_interpret,
                        total_interpret: total_interpret,
                        sessionid: parseInt(document.getElementById('sessionid').value),
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST'
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`网络错误: ${response.status}`);
                    }
                    return response.json(); // 解析JSON响应
                }).then(result => {
                    if (result.code === 0) {
                        //

                        // 记录完回答重新改为chat模式
                        total_interpret = result.total_interpret;
                        if (question_queue.length > 0) {
                            interpretation1 = interpretation_queue.shift();
                            question = question_queue.shift();

                            np_read(interpretation1 + question, 'system');

                        } else {

                            if ("start_summary" in result && result.start_summary) {
                                qa_flag = false;
                                addChatMessage(result.data, 'system')
                                // 这里是生成总结
                                total_chat('', 'chat', id, true, parseInt(document.getElementById('sessionid').value),
                                    qa_numb, report_interpret, total_interpret)
                                // 总结结束后，取消HRA选择的按钮
                            }

                        }

                        console.log("回答问题中....")
                    } else {
                        throw new Error(`业务错误: ${result.code}`);
                    }
                }).catch(error => {
                    console.error('请求失败:', error.message);
                    // 显示错误消息给用户
                    alert(`操作失败: ${error.message}`);
                });
            } else {
                // 根据report_interpret判断是生成问题还是rag问答
                fetch('/human', {
                    body: JSON.stringify({
                        text: message,
                        type: 'chat',
                        user_id: id,  // 用户id
                        interrupt: true,  // 是否打断
                        qa_numb: qa_numb, // hra问题数量
                        report_interpret: report_interpret, // hra解析
                        total_interpret: total_interpret,  // hra总结
                        sessionid: parseInt(document.getElementById('sessionid').value),
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST'
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`网络错误: ${response.status}`);
                    }
                    return response.json(); // 解析JSON响应
                }).then(result => {
                    if (result.code === 0) {
                        if ("is_qa" in result && result.is_qa) {
                            qa_numb = 1;
                            console.log("开始展示问题")
                            // 先读出第一个解析和问题，然后剩下的存队列，回答时进行出队操作
                            np_read(result.data[0].interpretation + result.data[0].question, 'system')
                            // setTimeout(()=>{np_read(result.data[0].question, 'system')},1000);
                            question = result.data[0].question
                            for (let i = 1; i < result.data.length; i++) {
                                interpretation_queue.push(result.data[i].interpretation);
                                question_queue.push(result.data[i].question);
                                qa_numb++;
                            }
                            qa_flag = true;
                        } else {
                            addChatMessage(result.data, 'system');
                        }
                        // addChatMessage(result.data, 'system');
                        //for (let i = 0; i < result.data.length; i++) {
                        //    let system_message = result.data[i].system_name+result.data[i].interpretation
                        //    addChatMessage(system_message, 'system');
                        // }
                        console.log('操作成功:', result);

                        // 处理成功逻辑，例如更新UI
                    } else {
                        throw new Error(`业务错误: ${result.code}`);
                        addChatMessage(result.data, 'user')
                    }
                }).catch(error => {
                    console.error('请求失败:', error.message);
                    // 显示错误消息给用户
                    alert(`操作失败: ${error.message}`);
                });
            }


            $('#chat-message').val('');
            // resetTimeout();
            // recognition.start();
        }

///////////////////////////////


        // 初始化语音识别
        async function initSpeechRecognition() {
            // 确保创建 SpeechRecognition 或 webkitSpeechRecognition 实例
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true; // 持续监听
                recognition.interimResults = true; // 获取中间结果
                recognition.lang = 'zh-CN'; // 设置为中文
                recognition.onresult = onResult; // 设置识别结果的回调函数
                recognition.start(); // 开始语音识别
                console.log('开始监听...');
            } else {
                alert('浏览器不支持语音识别功能');
            }
        }

        // 语音识别结果处理
        async function onResult(event) {
            let transcript = '';
            let finalTranscript = '';

            // 获取所有的识别结果
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const result = event.results[i];
                if (result.isFinal) {
                    finalTranscript += result[0].transcript + ' ';
                } else {
                    transcript += result[0].transcript;
                }
            }

            // 更新文本框显示识别结果
            transcriptBox.value = finalTranscript + transcript;

            // 每次有新的识别结果，重置定时器
            resetTimeout();
        }

        // 重置超时计时器
        async function resetTimeout() {
            clearTimeout(timeoutTimer);
            timeoutTimer = setTimeout(() => {
                let transcript = transcriptBox.value.trim();
                if (transcript) {
                    console.log('识别结果:', transcript); // 将识别结果输出到控制台
                    recognition.stop();
                    let mes="体检报告"
                    if (transcript.includes(mes)){
                        report_interpret=true
                        addChatMessage("hra报告解析已开始","system")
                        
                    }
                    chat_form(transcript)
                    recognition.start();
                }
                transcript=""
                transcriptBox.value=transcript
            }, 2000); // 2秒超时
        }

        // 页面加载时自动开始监听
        window.onload = () => {
            initSpeechRecognition();
        };


//////////////////////////////
        // WebRTC 相关功能
        if (typeof window.onWebRTCConnected === 'function') {
            const originalOnConnected = window.onWebRTCConnected;
            window.onWebRTCConnected = function () {
                updateConnectionStatus('connected');
                if (originalOnConnected) originalOnConnected();
            };
        } else {
            window.onWebRTCConnected = function () {
                updateConnectionStatus('connected');
            };
        }

        // 当连接断开时更新状态
        if (typeof window.onWebRTCDisconnected === 'function') {
            const originalOnDisconnected = window.onWebRTCDisconnected;
            window.onWebRTCDisconnected = function () {
                updateConnectionStatus('disconnected');
                if (originalOnDisconnected) originalOnDisconnected();
            };
        } else {
            window.onWebRTCDisconnected = function () {
                updateConnectionStatus('disconnected');
            };
        }

        // SRS WebRTC播放功能
        var sdk = null; // 全局处理器，用于在重新发布时进行清理

        function startPlay() {
            // 关闭之前的连接
            if (sdk) {
                sdk.close();
            }

            sdk = new SrsRtcWhipWhepAsync();
            $('#video').prop('srcObject', sdk.stream);

            var host = window.location.hostname;
            var url = "http://" + host + ":1985/rtc/v1/whep/?app=live&stream=livestream";

            sdk.play(url).then(function (session) {
                console.log('WebRTC播放已启动，会话ID:', session.sessionid);
            }).catch(function (reason) {
                sdk.close();
                console.error('WebRTC播放失败:', reason);
            });
        }


        $('#ids').on('click',function (e){
            id=$('#ids').val()
            id=parseInt(id)
        })

        $('#radar-form').on('submit', function (e) {
            e.preventDefault();


            addChatMessage("雷达波检测中", 'system');
            var message=JSON.stringify({
                "user_id": 1,
                "data": {"success": "true",
                    "failReason": "null",
                    "data": {
                        "success": 1,
                        "errorCode": 0,
                        "csgCollectId": "a8afa745-819c-46a0-aea3-02cfd4de3884",
                        "person": {
                            "name": "hsap",
                            "sex": "Male",
                            "age": 26
                        },
                        "startTime": "1745819347505",
                        "endTime": "1745819407505",
                        "heartRate": 76,
                        "conclusion": {
                            "heartConclusion": "在此次检查中：\n您的平均心率 76 次/分钟，房颤发生概率 0%，早搏发生概率 75%，心动过速发生概率 0%，心动过缓发生概率 0%，心律不齐发生概率 44%，心脏收缩时间间期(PEP/LVET)为 0.0，心电波形(QRS)时限 - 毫秒，(QT)间期 - 毫秒，心率变异性(rMSSD)为 29.48 毫秒，LF/HF为1.02 毫秒。\n此段心电图疑似早搏；若出现心悸、气短、胸闷、眩晕等症状，请咨询医生做进一步检查。",
                            "breathConclusion": "您的平均呼吸率 16 次/分钟，平均呼吸深度 9.0 毫米，呼气吸气比 5.73 。\n呼吸较深；若出现呼吸不畅、喘不上气、呼吸困难、头晕恶心等症状，请咨询医生做进一步检查。"
                        },
                        "sti": 0.0,
                        "hrvFeature": {
                            "sdnn": 25.753937,
                            "rmssd": 29.48272,
                            "pnn50": 0.46153846,
                            "cvsd": 0.03916111,
                            "cvcdi": 0.034208268,
                            "lf": 273.5398,
                            "hf": 267.2555,
                            "lfHfRatio": 1.0235142
                        },
                        "breathFeature": {
                            "breathRate": 16,
                            "avgBreathDepth": 9.00252,
                            "maxBreathDepth": 45.28404,
                            "minBreathDepth": 1.2028135,
                            "expiratoryTime": 825,
                            "inspiratoryTime": 4725
                        }
                    }
                }
            })
            var demo=$('#radar-textbox').val().trim()

            if(demo!==""){
                ms=JSON.parse(demo);
                ms.user_id=id
                message=JSON.stringify(ms)
                console.log(message)

            }
            fetch('/human', {
                body: JSON.stringify({
                    text: message,
                    type: 'radar',
                    report_interpret: false, //不是hra解析，默认false
                    user_id:id,
                    interrupt: true,
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(response => {
                console.log(response)
                if (!response.ok) {
                    throw new Error(`网络错误: ${response.status}`);
                }
                return response.json(); // 解析JSON响应
            }).then(result => {
                console.log(result)
                if (result.code === 0) {

                    addChatMessage(result.data, 'system');
                    console.log('操作成功:', result.data);

                    // 处理成功逻辑，例如更新UI
                } else {
                    throw new Error(`业务错误: ${result.code}`);
                }
            })
                .catch(error => {
                    console.error('请求失败:', error.message);
                    // 显示错误消息给用户
                    alert(`操作失败: ${error.message}`);
                });
        });

        // HRA解析按钮功能
        let isHRAEnabled = false;
        $('#user-select-btn').click(function (){
            var hra_t=$('#hra-textbox').val()
            fetch('/hra_t', {
                body: JSON.stringify({
                    text:hra_t,
                    user_id:id,
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(response => {
                console.log(response)
                if (!response.ok) {
                    throw new Error(`网络错误: ${response.status}`);
                }
                return response.json(); // 解析JSON响应
            }).then(result => {
                console.log(result)
                if (result.code === 0) {

                    addChatMessage(result.data, 'system');
                    console.log('操作成功:', result.data);

                    // 处理成功逻辑，例如更新UI
                } else {
                    throw new Error(`业务错误: ${result.code}`);
                }
            }).catch(error => {
                    console.error('请求失败:', error.message);
                    // 显示错误消息给用户
                    alert(`操作失败: ${error.message}`);
                });
        });

        $('#hra-toggle-btn').click(function () {
            isHRAEnabled = !isHRAEnabled;

            if (isHRAEnabled) {
                $(this).addClass('active');
                report_interpret = true;
                console.log('HRA解析已开启');

                // 可以在这里添加HRA解析开启后的逻辑
                addChatMessage('已开启HRA解析功能', 'system');
            } else {
                $(this).removeClass('active');
                report_interpret = false;
                console.log('HRA解析已关闭');

                // 可以在这里添加HRA解析关闭后的逻辑
                addChatMessage('已关闭HRA解析功能', 'system');
            }
        });
        // 数字人读操作

        function np_read(message, role) {
            console.log("要读的信息："+message)
            fetch('/human', {
                body: JSON.stringify({
                    text: message,
                    type: 'read',
                    interrupt: false,
                    report_interpret: report_interpret,
                    user_id:id,
                    sessionid: parseInt(document.getElementById('sessionid').value),
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
                method: 'POST'
            }).then(response => {
                if (!response.ok) {
h                }
                return response.json(); // 解析JSON响应
            }).then(result => {
                if (result.code === 0) {

                    addChatMessage(message, role);


                    console.log('读消息成功:', result);

                    // 处理成功逻辑，例如更新UI
                } else {
                    throw new Error(`业务错误: ${result.code}`);
                }
            })
                .catch(error => {
                    console.error('请求失败:', error.message);
                    // 显示错误消息给用户
                    alert(`操作失败: ${error.message}`);
                });

        };

        function total_chat(message,type,user_id,interrupt,sessionid,qa_numb,report_interpret,total_ip){
            // 根据report_interpret判断是生成问题还是普通问答
                        fetch('/human', {
                            body: JSON.stringify({
                                text: message,
                                type: type,
                                user_id: user_id,
                                interrupt: true,
                                sessionid: sessionid,
                                // 新增字段
                                qa_numb:qa_numb,
                                report_interpret: report_interpret,
                                total_interpret: total_ip,
                            }),
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            method: 'POST'
                        }).then(response => {
                            if (!response.ok) {
                                throw new Error(`网络错误: ${response.status}`);
                            }
                            return response.json(); // 解析JSON响应
                        }).then(result => {
                            if (result.code === 0) {
                                console.log("rag问答")
                                addChatMessage(result.data, 'system');
                               // $('#hra-toggle-btn').click();
                                report_interpret=!report_interpret
                                total_interpret = false;

                            } else {
                                throw new Error(`业务错误: ${result.code}`);
                                addChatMessage(result.data, 'user')
                            }
                        }).catch(error => {
                            console.error('请求失败:', error.message);
                            // 显示错误消息给用户
                            alert(`操作失败: ${error.message}`);
                        });
        }




    });
</script>
</body>

</html>
